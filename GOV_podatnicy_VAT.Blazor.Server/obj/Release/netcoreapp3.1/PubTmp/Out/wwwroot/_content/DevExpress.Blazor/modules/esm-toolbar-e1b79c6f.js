import"./esm-chunk-d81494b9.js";import"./esm-chunk-a2731447.js";import{ensureElement as t,findParentBySelector as e,calculateStyles as i,addClassNameToElement as s,removeClassNameFromElement as n,isRemovedFromDOM as r,RequestAnimationFrame as o,setStylesCore as a,subscribeElementContentSize as l,unsubscribeElement as h,pxToInt as u,getCurrentStyle as d,elementHasCssClass as c}from"./esm-dom-utils-aa188e06.js";import"./esm-chunk-9c16a801.js";import{d as m}from"./esm-chunk-208505fb.js";import"./esm-chunk-1b6abd73.js";import{initFocusHidingEvents as p}from"./esm-focus-utils-70e3961c.js";import{S as g}from"./esm-chunk-4bcd729b.js";const b=window.console;class f{constructor(t,e){if(!e)throw new Error("Collection should be able to create item");this.items=[],this.itemCreateFunc=e,this.subscriptions=[],this.isLocked=!1,this.isCollection=!0,this.subjectsCache={},t&&this.addRange(t)}subscribe(t){this.isLocked||t(this.getChanges(this.items)),this.subscriptions.push(t)}getChanges(t,e){return{addedItems:t||[],removedItems:e||[]}}forEach(t){this.items.forEach(t)}selectMany(t){return this.map(t).reduce((function(t,e){return t.concat(e.items||e)}),[])}reduce(t,e){return this.items.reduce(t)}map(t){return this.items.map(t)}filter(t){return this.items.filter(t)}any(){return this.count()>0}count(){return this.items.length}countAsSubject(){return this.getMethodAsSubject(this.count)}withSorting(t){return new window.Components.SortedCollection(this,t)}withGrouping(t){return new window.Components.GroupedCollection(this,t)}withFilter(t){return new window.Components.FilteredCollection(this,t)}withMapping(t){return new window.Components.MappedCollection(this,t)}anyAsSubject(t){return t?this.withFilter(t).anyAsSubject():this.getMethodAsSubject(this.any)}getMethodAsSubject(t){if(!this.subjectsCache[t]){const e=t.bind(this),i=this.subjectsCache[t]=new window.Components.Subject(e());this.subscribe((function(){i.setValue(e())}))}return this.subjectsCache[t]}get(t){return this.items[t]}add(t){this.addItemCore(t)&&this.raiseChanges([t],[])}remove(t){this.removeItemCore(t)&&this.raiseChanges([],[t])}addRange(t){this.raiseChanges(t.map(this.addItemCore.bind(this)).filter((function(t){return!!t})),[])}removeRange(t){this.raiseChanges([],t.map(this.removeItemCore.bind(this)).filter((function(t){return!!t})))}addItemCore(t){return this.items.indexOf(t)>-1?null:this.items[this.items.length]=t}removeItemCore(t){const e=this.items.indexOf(t);return-1===e?null:this.items.splice(e,1)}raiseChanges(t,e){const i=this.getChanges(t,e);(i.addedItems.length>0||i.removedItems.length>0)&&this.subscriptions.forEach((function(t){t(i)}))}serialize(){const t=Array(this.items.length);let e=!1;const i=window.getIndexSequence(this.items.length-1);return e=window.serialize(this.items,t,i)||e,e?t:void 0}update(t){const e=t.length<this.items.length?this.items.splice(t.length):[],i=window.getIndexSequence(Math.max(-1,t.length-this.items.length-1)).map(function(e){const i=e+this.items.length;return this.itemCreateFunc(i,t[i])}.bind(this));this.items=this.items.concat(i),window.deserialize(t,this.items,window.getIndexSequence(this.items.length-1)),this.raiseChanges(i,e)}lock(){this.isLocked=!0}unlock(){this.isLocked=!1}}class y{constructor(t,e,i){this.block=e,this.layer=t,this.width=0,i.subscribe(e,function(t,i){null===t&&(t=this.layer.getPrevLayer().getActualBlocks().filter((function(t){return t.block===e}))[0].width),t!==this.width&&(this.width=t,i||this.layer.requestUpdateLayoutModel())}.bind(this))}getMinWidth(){return this.width}getMaxWidth(){return this.getMinWidth()}}class I extends y{getMaxWidth(t){return t===this.layer?this.layer.getPrevLayer().getActualBlocks().filter(function(t){return t.block===this.block}.bind(this))[0].getMinWidth():this.getMinWidth()}}class x extends y{}class w extends y{}class C{constructor(t,e){this.widthCalculator=t,this.triggersResolver=e}subscribe(t,e){const s=this.widthCalculator.bind(this);this.triggersResolver(t).forEach((function(n){n.subscribe((function(){t.isWidthCalculationLocked||i((function(){e(s(t))}))}),!0)})),i((function(){e(s(t),!0)}))}}const k={fullWidthItem:new C((function(t){return t.getWidth()}),z),fullWidthSystemItem:new C((function(t){return t.getWidth()}),(function(t){return[]})),titleItem:new C((function(t){return t.getWidth()}),(function(t){return[t.toolbar.title.HasTitle,t.toolbar.title.Text]})),noTextItem:new C((function(t){return t.getNoTextWidth()}),z),contextItem:function(t){return new C((function(e){return t.items.filter((function(t){return"item"===t.getName()&&t.index<e.index&&t.isVisible()})).length>=e.toolbar.MinRootItems||!e.isVisible()?0:null}),z)},hiddenItem:new C((function(){return 0}),(function(){return[]}))};class L{constructor(t,e,i,s){this.stateName=t,this.nextLayer=null,this.prevLayer=i,i&&(i.nextLayer=this),this.layoutBlocks=[],this.blockUpdaterGetter=e,this.latestRange=null,this.canApply=s}getNextLayer(){return null!=this.nextLayer?this.nextLayer.canApply()?this.nextLayer:this.nextLayer.getNextLayer():null}getPrevLayer(){return null!=this.prevLayer?this.prevLayer.canApply()?this.prevLayer:this.prevLayer.getPrevLayer():null}requestUpdateLayoutModel(){this.getPrevLayer().requestUpdateLayoutModel()}isValidWidth(t){if(!this.canApply())return!1;const e=this.getRange();return!this.getNextLayer()&&e.min>t||!this.getPrevLayer()&&e.max<t||e.min<=t&&e.max>=t}getRange(){return this.latestRange=this.getActualBlocks().reduce(function(t,e){return{min:t.min+e.getMinWidth(),max:t.max+e.getMaxWidth(this)}}.bind(this),{min:0,max:0})}getActualBlocks(){return this.getPrevLayer()?this.getPrevLayer().getActualBlocks().map(function(t){return this.layoutBlocks.filter((function(e){return e.block===t.block}))[0]||t}.bind(this)):this.layoutBlocks}activate(t){this.layoutBlocks.forEach(function(t){t.block.updateStateCore(this.stateName)}.bind(this))}addBlock(t){const e=this.blockUpdaterGetter(t);e&&this.layoutBlocks.push(this.createBlock(t,e))}removeBlock(t){}createBlock(t,e){}}class v extends L{constructor(t,e,i,s){super(t,e,null,s),this.layoutModel=i}requestUpdateLayoutModel(){this.layoutModel.updateLayout()}createBlock(t,e){return new w(this,t,e)}}class M extends L{activate(t){const e=this.getActualBlocks();let i=this.latestRange.max,s=this.stateName;for(let n=e.length-1;n>=0;n--){const r=e[n];if(i>t){if(i-=r.getMaxWidth(this)-r.getMinWidth(),i<=t){r.block.updateStateCore(s),s=this.getPrevLayer().stateName;continue}}r.block.updateStateCore(s)}}getRange(){return this.latestRange=this.getActualBlocks().reduce(function(t,e){return{min:t.min+e.getMinWidth(),max:t.max+e.getMaxWidth(this)}}.bind(this),{min:0,max:0})}createBlock(t,e){return new I(this,t,e)}}class W extends L{createBlock(t,e){return new x(this,t,e)}getRange(){return this.latestRange={min:this.getActualBlocks().reduce((function(t,e){return t+e.getMinWidth()}),0),max:this.getPrevLayer().getRange().max-1}}}class S{constructor(t){this.layers=[],this.currentWidth=null,this.onLayerApplied=t}initialize(t,e,i){this.elementContentWidthSubscription=l(e,e=>{this.currentWidth===e.width&&this.currentHeight===e.height||(null===this.currentWidth&&t.subscribe(function(t){t.addedItems.forEach(this.addBlock.bind(this)),t.removedItems.forEach(this.removeBlock.bind(this))}.bind(this)),this.currentWidth=e.width,this.currentHeight=e.height,i&&i(e))})}dispose(){this.elementContentWidthSubscription&&h(this.elementContentWidthSubscription)}getLastLayer(){return this.layers[this.layers.length-1]||null}defaultLayer(t,e){this.layers.push(new v("default",t,this,e))}simultaneousTransitionLayer(t,e,i){this.layers.push(new W(t,e,this.getLastLayer(),i))}sequentialTransitionLayer(t,e,i){this.layers.push(new M(t,e,this.getLastLayer(),i))}addBlock(t){this.layers.forEach((function(e){e.addBlock(t)}))}removeBlock(t){this.layers.forEach((function(e){e.removeBlock(t)}))}updateLayout(){const t=this.findLayersForWidth(this.currentWidth);t.length>0&&this.applyLayer(t[0])}resetToDefault(){this.applyLayer(this.layers[0])}applyLayer(t){t.activate(this.currentWidth),this.onLayerApplied&&this.onLayerApplied(t)}findLayersForWidth(t){return this.layers.filter((function(e){return e.isValidWidth(t)}))}forceUpdate(){null!==this.currentWidth&&this.updateLayout()}}class R extends class{constructor(){this.state=null,this.isWidthCalculationLocked=!1}updateStateCore(t){this.state=t,this.updateState(t)}updateState(t){}getElement(){}getGlobalRefreshTrigger(){}}{constructor(t,e){super(),this.element=e,this.toolbar=t}getWidth(){return this.isVisible()?U(this.getElement()):0}isVisible(){return!0}getName(){}getElement(){return this.element}getGlobalRefreshTrigger(){return this.toolbar.RefreshTrigger}}class T extends R{constructor(t,e){super(t),this.item=e,this.index=-1}getElement(){return this.item.getElement()}updateState(t){this.item.IsDisplayed.update(t.indexOf("has-"+this.getName())>-1)}}class A extends T{constructor(t,e){super(t,e)}getNoTextWidth(){return this.item.IsDisplayed.value?function(t){let e=U(t);if(t){const i=t.querySelector(".image");if(i){e-=O(i);let t=i;for(;t=t.nextElementSibling;)c(t,"popout")||"absolute"===d(t).position||(e-=U(t))}}return e}(this.getElement()):0}getName(){return"item"}isVisible(){return this.item.IsDisplayed.value}updateState(t){const e=this.item.toolbar;this.updateVisible(e.MinRootItems>0?-1===t.indexOf("has-ellipsis")||this.index<e.MinRootItems:-1===t.indexOf("has-ellipsis")&&-1===t.indexOf("has-sidemenu"))}updateVisible(t){t||(this.isWidthCalculationLocked=!0),this.item.updateVisible(t),t&&(this.isWidthCalculationLocked=!1)}}class E extends T{constructor(t,e){super(t,e)}getName(){return"ellipsis"}updateState(t){T.prototype.updateState.call(this,t),this.updateVisible(this.item.IsDisplayed.value)}updateVisible(t){t||(this.isWidthCalculationLocked=!0),this.item.updateVisible(t),t&&(this.isWidthCalculationLocked=!1)}}class B extends A{constructor(t,e){super(t,e),this.itemBlocks=[],this.addItem(e)}addItem(t){this.itemBlocks.push(new A(this.toolbar,t))}isVisible(){return this.itemBlocks.reduce((function(t,e){return t&&e.isVisible()}),!0)}getWidth(){return this.itemBlocks.reduce((function(t,e){return t+e.getWidth()}),0)}getNoTextWidth(){return this.itemBlocks.reduce((function(t,e){return t+e.getNoTextWidth()}),0)}updateVisible(t){this.itemBlocks.forEach((function(e){e.updateVisible(t)}))}tryAddItem(t){const e=this.itemBlocks[this.itemBlocks.length-1].item;let i=!1;return(i=e.GroupName===t.GroupName&&e.group===t.group&&e.AdaptivePriority.value===t.AdaptivePriority.value)&&this.addItem(t),i}}class V extends R{constructor(t,e,i){super(t,e),this.item=i}getName(){return"title"}getWidth(){return U(this.getElement(),!0)}getElement(){return this.item.getElement()}}class N{constructor(t,e){this.element=t,this.toolbar=e,this.IsVisible=new g(this.defaultIsVisible()),this.IsVisible.subscribe(function(t){this.onIsVisibleChanged(t)}.bind(this),!0)}defaultIsVisible(){return!0}getElement(){return this.element}updateVisible(t){this.IsVisible.update(t)}onIsVisibleChanged(t){const e=this.getElement();e&&(t?this.show(e):this.hide(e))}show(t){t.classList.remove("ta-hidden-item")}hide(t){t.classList.add("ta-hidden-item")}}class P extends N{constructor(t,e,i){super(t,i),this.group=e,this.IsDisplayed=new g(!0),this.Text=new g,this.GroupName=new g,this.AdaptivePriority=new g,this.Index=new g,this.IconCssClass=new g}onIsVisibleChanged(t){super.onIsVisibleChanged(t),this.group.onItemVisibleChanged()}getElement(){return document.querySelector(F("data-dxtoolbar-item-id",this.Id))}getParent(){const t=this.getElement();if(t&&t.parentNode)return t.parentNode}show(t){a(t,"display","")}hide(t){a(t,"display","none")}}class q extends N{constructor(t,e){super(t,e),this.items=[]}addItem(t){this.items.push(t)}onItemVisibleChanged(){if(0===this.items.length)return;const t=this.items.some(t=>t.IsVisible.value);this.updateVisible(t)}getElement(){if(0===this.items.length)return null;const t=e(this.items[0].getElement(),F("data-dxtoolbar-group-id",this.toolbar.id));return t||this.items[0].getParent()}}class j{constructor(t){this.element=t,this._refreshTrigger=new g(!1),this.itemMap=new Map,this.groupMap=new Map,this.items=[]}get RefreshTrigger(){return this._refreshTrigger.asTrigger(t=>!t)}refresh(){this._refreshTrigger.update(this.refreshTrigger.value)}}class H extends N{constructor(t,e){super(t,e),this.toolbar=e,this.element=t,this.IsDisplayed=new g(!0),this.Text=new g}defaultIsVisible(){return null}show(t){a(t,"display","")}hide(t){a(t,"display","none")}}class D extends N{constructor(t,e,i){super(t,e),this.toolbar=e,this.HasTitle=new g,this.Text=new g,this.Text.subscribe(function(t){this.HasTitle.update(null!=t&&""!==t)}.bind(this)),this.elementSelector=i}getElement(){return document.querySelector(this.elementSelector)}}class G{constructor(){this.IsLoading=!0}init(t,o,a){this.isLayoutCalculated=!1;const l=a,h=t.dataset.dxtoolbarId,u=F("data-dxtoolbar-title-id",h),d=F("data-dxtoolbar-ellipses-id",h),c=document.querySelector(d),m=this.toolbar=new j(t),p=m.groupMap;m.id=h,Array.from(o.items).forEach((t,i)=>{const s=document.querySelector(F("data-dxtoolbar-item-id",t.id)),n=e(s,F("data-dxtoolbar-group-id",h));let r=null;p.has(n)?r=p.get(n):(r=new q(n,m),p.set(n,r));const o=new P(s,r,m);o.Text.update(t.text),o.GroupName.update(t.groupName),o.AdaptivePriority.update(t.adaptivePriority),o.IconCssClass.update(t.iconCssClass),o.IsDisplayed.update(t.visible),o.Index.update(t.index),o.Id=t.id,m.itemMap.set(o.Id,o),m.items.some(t=>t.Index.value===o.Index.value)||(r.addItem(o),m.items.push(o))}),m.CanHideRootItems=o.canHideRootItems,m.CanCollapseToIcons=o.canCollapseToIcons,m.MinRootItems=o.minRootItems,m.ItemSize=o.itemSize,m.RenderMode=o.renderMode;const g=new f([],t=>{});m.title=new D(m.title,m,u),g.add(new V(m,m.title,m.title)),g.addRange(this.getItemsBlocks(m,new f(Array.from(p.values()),(function(){}))));const y=new H(c,m);y.Id=o.adaptiveMenuModel.id,g.add(new E(m,y)),m.ellipses=y;const I=k.contextItem(g),x=this.Model=new S(function(e){if(!this.isLayoutCalculated){this.isLayoutCalculated=!0;const t=m.element;i(function(){const e=t.querySelector(".btn-toolbar");this.updateControlStyles(m,Math.ceil(!this.IsLoading&&e?e.offsetHeight:t.offsetHeight)),this.IsLoading=!1}.bind(this))}const o=m.element.querySelector(".btn-toolbar")||m.element;if(e.stateName.indexOf("no-item-text")>-1?s(o,"no-item-text"):n(o,"no-item-text"),n(t,"dxbs-loading"),r(t))return;const a=m.items.concat(m.ellipses).map(t=>({Id:t.Id,IsVisible:t.IsVisible.value}));l.invokeMethodAsync("OnModelUpdated",Array.from(a)).catch((function(e){r(t)||b.error(e)}))}.bind(this));x.defaultLayer((function(t){switch(t.getName()){case"item":return k.fullWidthItem;case"title":return k.titleItem}return k.hiddenItem}),()=>!0),x.sequentialTransitionLayer("has-ellipsis",(function(t){switch(t.getName()){case"ellipsis":return k.fullWidthSystemItem;case"item":return I}}),()=>m.CanHideRootItems&&m.MinRootItems>0),x.simultaneousTransitionLayer("no-item-text",(function(t){switch(t.getName()){case"item":return k.noTextItem;case"ellipsis":return k.hiddenItem}}),()=>m.CanCollapseToIcons),x.sequentialTransitionLayer(m.CanCollapseToIcons?"no-item-text has-ellipsis":"has-ellipsis",(function(t){switch(t.getName()){case"item":return I;case"ellipsis":return k.fullWidthSystemItem}}),()=>m.CanHideRootItems),x.initialize(g,m.element.querySelector(".btn-toolbar")||m.element,function(t){this.height!==t.height&&(this.isLayoutCalculated=!1,this.height=t.height),this.layoutModel.updateLayout()}.bind(this)),this.layoutModel=x}reinit(t,e){this.reinitRequested||(this.reinitRequested=!0,o(function(){this.resetToDefault(),this.disposeModel(),o(function(){this.reinitRequested=!1,this.init(t.mainElement,t,e)}.bind(this))}.bind(this)))}resetToDefault(){this.layoutModel.resetToDefault()}update(t,e){let i=!1,s=!1;this.toolbar.CanHideRootItems!==t.canHideRootItems&&(this.toolbar.CanHideRootItems=t.canHideRootItems,i=!0),this.toolbar.CanCollapseToIcons!==t.canCollapseToIcons&&(this.toolbar.CanCollapseToIcons=t.canCollapseToIcons,i=!0),this.toolbar.MinRootItems!==t.minRootItems&&(this.toolbar.MinRootItems=t.minRootItems,i=!0),this.toolbar.ItemSize!==t.itemSize&&(this.toolbar.ItemSize=t.itemSize,s=!0),this.toolbar.RenderMode!==t.renderMode&&(this.toolbar.RenderMode=t.renderMode,s=!0),this.toolbar.title.Text.update(t.title);const n=Array.from(t.items).map(t=>t.id),r=Array.from(this.toolbar.itemMap.values()).map(t=>t.Id);var o,a;if(s=s||!((o=n).length===(a=r).length&&o.every((t,e)=>t===a[e])),s)return this.reinit(t,e),void 0;Array.from(t.items).forEach((t,e)=>{const i=this.toolbar.itemMap.get(t.id);i&&(i.Text.update(t.text),i.GroupName.update(t.groupName),i.AdaptivePriority.update(t.adaptivePriority),i.Index.update(t.index),i.IconCssClass.update(t.iconCssClass),i.IsDisplayed.update(t.visible))}),i&&this.layoutModel.forceUpdate()}disposeModel(){this.layoutModel&&this.layoutModel.dispose()}dispose(){this.disposeModel()}getItemsBlocks(t,e){return e.selectMany((function(t){return t.items})).reduce(function(e,i){return e.group&&e.group.tryAddItem(i)?e:i.GroupName?{group:e.blocks[e.blocks.length]=new B(t,i),blocks:e.blocks}:{group:null,blocks:e.blocks.concat([new A(t,i)])}}.bind(this),{blocks:[],group:null}).blocks.sort((function(t,e){return t.item.AdaptivePriority.value-e.item.AdaptivePriority.value})).map((function(t,e){return t.index=e,t}))}updateControlStyles(t,e){a(t.element,"height",e+"px")}}function z(t){return[t.item.Text,t.item.IsDisplayed,t.item.IconCssClass]}function U(t,e){let i=t?Math.ceil(t.offsetWidth+(e?0:O(t))):0;if(t){if(t.parentElement.lastElementChild===t){const e=d(t.parentElement);i+=u(e.marginRight)}if(t.parentElement.firstElementChild===t){const e=d(t.parentElement);i+=u(e.marginLeft)}}return i}function O(t){return function(t,e){const i=e||d(t);return u(i.marginLeft)+u(i.marginRight)}(t)}function F(t,e){return`[${t}=${e}]`}const _=new Map;function $(e,i,s){const n=t(e);if(null===n)return;m(n);let r=_.get(n);r?r.update(i,s):(r=new G,r.init(n,i,s),_.set(n,r));const o=n.querySelector(".btn-toolbar")||n;return p(o),Promise.resolve("ok")}function J(e){if(e=t(e)){m(e);const t=_.get(e);t&&(t.dispose(),_.delete(e))}return Promise.resolve("ok")}const K={init:$,dispose:J};export default K;export{J as dispose,$ as init};
